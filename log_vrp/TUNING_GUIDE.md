# GMOEA VRPTW 求解器 - 参数调优指南

## 问题现象分析

根据你的训练反馈：
- **700代稳定在** (1757.67, 2106.51, 10) 
- **2000代仅改进到** (1676.23, 2029.92, 10) ≈ **5% 改进**
- 表现症状：**早熟收敛**、**多样性丧失**、**局部搜索强度不足**

## 核心调优原则

### 1. 多样性 vs 收敛速度
- **太保守**（低变异、高交叉）→ 快速收敛但容易陷入局部最优
- **太激进**（高变异、低交叉）→ 收敛慢但搜索空间更广

### 2. 种群大小的作用
- 大种群（300+）→ 覆盖解空间更广，但计算成本高
- 小种群（50-100）→ 快速迭代，但多样性受限

### 3. 局部搜索的平衡
- 频繁（每代执行）→ 快速优化但可能限制全局搜索
- 间隔执行（每N代）→ 保留全局搜索机会

---

## 推荐配置档位

### 档位 A：保守型（Conservative） ✓ 快速验证
**适用场景**：算法测试、快速迭代、小规模实例
```python
config_preset = 'conservative'
# population_size: 50
# max_generations: 300
# mutation_rate: 0.3        # 高变异以保持多样性
# crossover_rate: 0.7       # 较低交叉
# local_search_freq: 1      # 轻量局部搜索
# local_search_depth: 'light'
```
**预期结果**：5-10分钟内得到可行解，质量中等
**风险**：收敛缓慢

---

### 档位 B：平衡型（Balanced） ✓ 推荐用于中等规模VRPTW
**适用场景**：Solomon数据集（100+客户）、生产应用、追求质量与时间的平衡
```python
config_preset = 'balanced'
# population_size: 150
# max_generations: 1000
# mutation_rate: 0.35       # 增强探索
# crossover_rate: 0.75      # 中等交叉
# local_search_freq: 2      # 每2代执行一次
# local_search_depth: 'medium'  # 2-opt + 基本合并
```
**预期结果**：30-60分钟内得到接近已知最优解的方案
**特点**：
- 150人口相比200更精准，避免过度计算
- 35% 变异率延缓早熟
- 每2代做一次局部搜索保留全局机会
- medium深度的合并在速度与效果间平衡

---

### 档位 C：激进型（Aggressive） ✓ 追求最优解
**适用场景**：需要尽可能接近全局最优、计算资源充足、不限制时间
```python
config_preset = 'aggressive'
# population_size: 300
# max_generations: 3000
# mutation_rate: 0.4        # 最高变异，防止收敛
# crossover_rate: 0.8       # 保持有效基因传递
# local_search_freq: 1      # 每代执行强化搜索
# local_search_depth: 'heavy'  # 完整2-opt + 多轮合并
```
**预期结果**：2-4小时内得到与已知最优解(827.3)相近的方案
**特点**：
- 300人口大幅增加覆盖
- 40% 变异率最大化探索
- 每代执行heavy搜索，高强度优化
- 3000代充分时间收敛

---

## 针对你的情况的具体建议

### 场景1：如果时间允许，追求最优解
**推荐**：Aggressive + 额外微调
```python
config_preset = 'aggressive'
# 然后在 main_train.py 中可进一步微调：
config['population_size'] = 350  # 再加50人
config['max_generations'] = 4000  # 多1000代
config['mutation_rate'] = 0.42    # 稍微提高
```
**预期改进**：从1676.23 → 1550-1650（再10-15%改进）

### 场景2：在当前时间约束下（2000代）想得到更好结果
**推荐**：Balanced + 关键调整
```python
config_preset = 'balanced'
# 加强关键参数：
config['population_size'] = 200   # 比平衡型多50
config['mutation_rate'] = 0.38    # 比平衡型提高3%
config['local_search_freq'] = 1   # 改为每代执行（而非每2代）
config['local_search_depth'] = 'medium'  # 保持medium
```
**预期改进**：从1676.23 → 1620-1660（5-8%改进）

### 场景3：快速测试新想法（分钟级）
**推荐**：Conservative
```python
config_preset = 'conservative'
# 适合快速验证算法修改、数据加载等
```

---

## 参数微调清单

如果仍未达到预期，按优先级尝试下列调整：

### 高优先级（快速见效）
- [ ] 增加 `population_size` (+50-100)
- [ ] 提高 `mutation_rate` (+0.05-0.1)  
- [ ] 改为 `local_search_freq = 1`（每代执行）
- [ ] 增加 `max_generations` (+500-1000)

### 中优先级（细致优化）
- [ ] 调整 `crossover_rate` (0.7~0.85范围内试)
- [ ] 改用 `local_search_depth = 'heavy'`
- [ ] 调整 `print_interval`（100+ 以减少输出开销）

### 低优先级（实验性）
- [ ] 启用 `use_nn = True`（加入神经网络辅助）
- [ ] 改用 `balance_strategy = 'even'` 对比
- [ ] 实现自适应交叉/变异率

---

## 预期结果参考

| 档位 | 时间 | 最佳目标1(距离) | 最佳目标2(时间) | 最佳目标3(车数) | 质量相对于C101.sol(827.3) |
|------|------|----------------|----------------|----------------|--------------------------|
| Conservative | 5-10分钟 | 1900+ | 2200+ | 12-15 | 90-95% |
| Balanced | 30-60分钟 | 1650-1750 | 2000-2100 | 10 | 80-90% |
| Aggressive | 2-4小时 | 1550-1650 | 1950-2050 | 10 | 75-85% |

*注：质量指标为目标1（总距离）与已知最优解的比率*

---

## 监控指标

### 收敛曲线正常迹象
- Gen 100: 最佳距离 ~2000
- Gen 500: 最佳距离 ~1750
- Gen 1000: 最佳距离 ~1680
- Gen 2000: 最佳距离 ~1650
- **增量逐渐放缓但不停滞** ✓

### 早熟收敛迹象（需要调参）
- Gen 300: 最佳距离 ~1750
- Gen 600: 最佳距离 ~1748 ← 停滞！
- Gen 2000: 最佳距离 ~1745
- **600代后基本无进展** ✗ → 增加变异率、人口数、或局部搜索频率

---

## 使用方式

### 快速切换配置
编辑 `main_train.py` 第10行：
```python
config_preset = 'balanced'  # 改这里
```

### 精细调优
在选定 preset 后，继续编辑 `config` 字典（大约第50-65行）：
```python
config = {
    **config_presets[config_preset],
    ...
    'population_size': 180,  # 覆盖原preset的值
    'mutation_rate': 0.37,
}
```

---

## 问题排查

### Q: 为什么从700代到2000代改进不足5%？
**A**: 
1. 变异率太低（0.2 → 0.3+）
2. 人口多样性不足（200 → 300+）
3. 局部搜索过于激进/频繁，限制了全局搜索

### Q: 怎么判断选对了参数？
**A**: 
- 若1000代之前还在稳定改进 → 参数较好
- 若仍在600代停滞 → 增加变异率和人口
- 若超过4000代改进不足1% → 已接近该配置的极限

### Q: 能否结合神经网络进一步提升？
**A**: 可以，设 `use_nn = True`，但需要更多时间。建议先用纯进化验证参数，再引入NN。

---

## 总结建议表

根据你的目标选择：

| 目标 | 推荐档位 | 关键调整 | 预计时间 |
|------|---------|--------|---------|
| 快速验证算法 | Conservative | 无 | 5-10分 |
| 得到接近最优的解 | Balanced | +50人, +变异5% | 30-60分 |
| 逼近全局最优 | Aggressive | 无 | 2-4小时 |
| 当前卡在1676就想突破 | Balanced++ | +100人, +变异8%, 改freq=1 | 1-2小时 |

---

**最后提示**：参数调优是实验驱动的。建议：
1. 选一个档位运行1000代观察曲线
2. 若收敛缓慢 → 增加人口/代数
3. 若早熟 → 增加变异率/局部搜索频率
4. 迭代调整直到满意
